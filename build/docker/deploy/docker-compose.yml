version: '3.5'

services:
  master:
    image: ${TARGET_REPO}/master:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/master/DockerFile
      cache_from:
        - ${SOURCE_REPO}/master:${SOURCE_TAG}
    environment: 
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      INDEX_BUILDER_ADDRESS: ${INDEX_BUILDER_ADDRESS}
    networks: 
      - milvus

  proxy:
    image: ${TARGET_REPO}/proxy:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/proxy/DockerFile
      cache_from:
        - ${SOURCE_REPO}/proxy:${SOURCE_TAG}
    environment: 
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      MASTER_ADDRESS: ${MASTER_ADDRESS}
    networks: 
      - milvus

  indexbuilder:
    image: ${TARGET_REPO}/indexbuilder:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/indexbuilder/DockerFile
      cache_from:
        - ${SOURCE_REPO}/indexbuilder:${SOURCE_TAG}
    environment:
      MASTER_ADDRESS: ${MASTER_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      MINIO_ADDRESS: ${MINIO_ADDRESS}

    networks:
      - milvus

  querynode:
    image: ${TARGET_REPO}/querynode:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/querynode/DockerFile
      cache_from:
        - ${SOURCE_REPO}/querynode:${SOURCE_TAG}
    environment: 
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      MASTER_ADDRESS: ${MASTER_ADDRESS}
      MINIO_ADDRESS: ${MINIO_ADDRESS}
    networks:
      - milvus

  writenode:
    image: ${TARGET_REPO}/writenode:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/writenode/DockerFile
      cache_from:
        - ${SOURCE_REPO}/writenode:${SOURCE_TAG}
    environment: 
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      MASTER_ADDRESS: ${MASTER_ADDRESS}
      MINIO_ADDRESS: ${MINIO_ADDRESS}
    networks:
      - milvus

networks:
  milvus:
